<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Multiphysics Modeling with the preCICE Coupling Library</title>

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="dist/theme/precice.css" id="theme">

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/atom-one-light.css" id="highlight-theme">

        <style>
        .container{
            display: flex;
        }
        .col{
            flex: 1;
        }
        </style>

        <!-- FontAwesome -->
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
        <style> .reveal i.fa { font-family:FontAwesome; font-style: normal; } </style>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
        
                <!-- Title slide -->
                <section>
                    <small>15th OpenFOAM Workshop - June 24, 2020 - Training III-E</small>
                    <h1>Multiphysics Modeling with the preCICE Coupling Library</h1>
                    <div style="margin-top:50pt">
                        <div>
                            <small>Gerasimos Chourdakis, Technical University of Munich<br/><a href="mailto:chourdak@in.tum.de">chourdak@in.tum.de</a></small><br/>
                            <img data-src="images/logos/tum.png" style="border:none; box-shadow:none; height:30px;">
                        </div>
                        <div style="margin-top:20pt">
                            <small>Benjamin Uekermann, Eindhoven University of Technology<br/><a href="mailto:b.w.uekermann@tue.nl">b.w.uekermann@tue.nl</a></small><br/>
                            <img data-src="images/logos/tue.png" style="border:none; box-shadow:none; height:30px;">
                        </div>
                    </div>
                </section>
                
                <section data-markdown="sections/intro.md" data-separator-vertical="vvv"></section>
                
                <!-- Level 1: General -->
                <section data-markdown data-separator-vertical="vvv">
                    <textarea data-template>
                        # Level 1: Coupling two simple solvers

                        ---

                        ## Dependencies

                        - [preCICE](https://github.com/precice/precice/wiki/Get-preCICE) v2 (e.g. [packages for Ubuntu](https://github.com/precice/precice/releases))
                        - Python 3
                        - Python packages `numpy`, `matplotlib`
                        - [preCICE Python bindings](https://github.com/precice/python-bindings):
                           ```bash
                           pip3 install --upgrade pip
                           pip3 install --user pyprecice
                           ```
                        
                        ---

                        ## "Generator" and "Propagator"

                        <div class="container" style="margin-top:50pt">

                        <div class="col">

                        - `generator.py`: generates random data in a 1D domain
                        - `propagator.py`: propagates boundary data over a 2D domain
                        </div>

                        <div class="col">
                        <img data-src="images/level1/propagator_description.png" style="border:none; box-shadow:none; max-width:100%;">
                        </div>

                        </div>

                        ---

                        ## Unidirectional coupling

                        <img data-src="images/level1/serial-explicit.svg" style="border:none; box-shadow:none; max-width:80%;">
                        
                        ---

                        ## generator.py

                        ```python
                        import numpy
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                        ```

                        <small>Find these files in <a href="https://github.com/MakisH/ofw15-slides/training/generator-propagator">github.com/MakisH/ofw15-slides/training/generator-propagator</a>.</small>

                        vvv

                        ## propagator.py

                        ```python
                        # generate mesh
                        n = 20
                        x = numpy.linspace(0, 1, n+1)
                        y = numpy.linspace(0, 1, n+1)

                        # initial data, associated to cell centers
                        u = numpy.zeros([n, n])

                        dt = 0.01
                        t = 0

                        # boundary condition for u (arbitrary)
                        u[:,-1] = y[:-1] 

                        while True:
                          
                          print("Propagating data")
                          # some (arbitrary) convection-diffusion rule
                          # top row
                          u[0, :-1] = 0.3 * u[0, :-1] + 0.6 * u[0, 1:] + 0.1 * u[1, :-1] 
                          # inner domain
                          u[1:-1, :-1] = 0.2 * u[1:-1, :-1] + 0.6 * u[1:-1, 1:] + 0.1 * u[2:, :-1] + 0.1 * u[:-2, :-1]
                          # bottom row
                          u[-1, :-1] = 0.3 * u[-1, :-1] + 0.6 * u[-1, 1:] + 0.1 * u[-1, :-1]

                          t = t + dt 
                          if(t > 0.2):
                            break
                        ```
                    </textarea>
                </section>
                
                <section>
                    <section>
                        <script id="asciicast-342201" src="https://asciinema.org/a/342201.js" async data-autoplay="true" data-size="medium" preload="1"></script>
                        <!-- <a href="https://asciinema.org/a/342201" target="_blank"><img src="https://asciinema.org/a/342201.svg" /></a> -->
                    </section>
                    <section>
                        <h2>Uncoupled simulation</h2>
                        <p><a href="https://github.com/MakisH/ofw15-slides/blob/master/videos/propagator_constant.webm"><video data-autoplay src="videos/propagator_constant.webm"></video></a></p>
                    </section>
                </section>
                
                <!--- Level 1: Code step-by-step -->
                <!-- Base -->
                <section>
                <section data-auto-animate>
                    <h2>Import preCICE</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers>
                        import numpy
                        
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                    </code></pre>
                </section>
                <!-- Import preCICE -->
                <section data-auto-animate>
                    <h2>Import preCICE</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="2">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                    </code></pre>
                </section>
                <!-- Configure preCICE -->
                <section data-auto-animate>
                    <h2>Configure preCICE</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="2|8-19">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )

                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                    </code></pre>
                </section>
                <!-- Define the coupling mesh -->
                <section data-auto-animate>
                    <h2>Define the coupling mesh</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="8-19|21-27">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                        
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                    </code></pre>
                </section>
                <!-- Initialize and finalize preCICE -->
                <section data-auto-animate>
                    <h2>Initialize and finalize preCICE</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="21-27|29,42">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                        
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        interface.initialize()

                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                        
                        interface.finalize()
                    </code></pre>
                </section>
                <!-- Advance the coupling: focus -->
                <section data-auto-animate>
                    <h2>Advance the coupling</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="29,44|34-42">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                                             
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                         
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        interface.initialize()

                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                        
                        interface.finalize()
                    </code></pre>
                </section>
                <!-- Advance the coupling: call -->
                <section data-auto-animate>
                    <h2>Advance the coupling</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="34-42">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                         # Get the preCICE mesh id
                         mesh_name  = "Generator-Mesh"
                         mesh_id    = interface.get_mesh_id(mesh_name)
                         
                         # Define the coupling mesh
                         vertices   = [[1, y0] for y0 in y[:-1]]
                         vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        interface.initialize()

                        dt = 0.01
                        t = 0

                        while True:
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          interface.advance(dt)
                          
                          t = t + dt 
                          if(t > 0.1):
                            break
                        
                        interface.finalize()
                    </code></pre>
                </section>
                <!-- Advance the coupling: end -->
                <section data-auto-animate>
                    <h2>Advance the coupling</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="34-42">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                        
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        interface.initialize()

                        dt = 0.01
                        t = 0

                        while interface.is_coupling_ongoing():
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          interface.advance(dt)
                          
                          t = t + dt 
                        
                        
                        
                        interface.finalize()
                    </code></pre>
                </section>
                <!-- Advance the coupling: time -->
                <section data-auto-animate>
                    <h2>Advance the coupling</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="34-42">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                        
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        interface.initialize()

                        dt = 0.01
                        t = 0

                        while interface.is_coupling_ongoing():
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          precice_dt = interface.advance(dt)
                          
                          t = t + dt 
                        
                        
                        
                        interface.finalize()
                    </code></pre>
                </section>
                <!-- Advance the coupling: time 2-->
                <section data-auto-animate>
                    <h2>Advance the coupling</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="34-42|29,34-42">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                        
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        precice_dt = interface.initialize()

                        dt = 0.01
                        t = 0

                        while interface.is_coupling_ongoing():
                          dt = np.minimum(dt, precice_dt)
                          
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          precice_dt = interface.advance(dt)
                          
                          t = t + dt 
                        
                        interface.finalize()
                    </code></pre>
                </section>
                </section>
                <!-- Run and results -->
                <section>
                <section>Not there yet, but let's run it<br/><small>(similar changes in <tt>propagator.py</tt> - try it at home)</small></section>
                <section>
                    <script id="asciicast-UwMVk0tbq8cOCdTd5dEpNh7F3" src="https://asciinema.org/a/UwMVk0tbq8cOCdTd5dEpNh7F3.js" data-autoplay="true" data-size="medium" preload="1"></script>
                    <!-- <a href="https://asciinema.org/a/341502" target="_blank"><img src="https://asciinema.org/a/341502.svg" /></a> -->
                </section>
                <section>
                    <h2>Nothing happening?</h2>
                    <p><a href="https://github.com/MakisH/ofw15-slides/blob/master/videos/propagator_constant.webm"><video data-autoplay src="videos/propagator_constant.webm"></video></a></p>
                    <small>Did we forget something?</small>
                </section>
                </section>
                <section>
                <!-- Write & read data: focus -->
                <section data-auto-animate>
                    <h2>Write & read data</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="25-31">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                         
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        



                        
                        precice_dt = interface.initialize()

                        dt = 0.01
                        t = 0

                        while interface.is_coupling_ongoing():
                          dt = np.minimum(dt, precice_dt)
                          
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          

                          precice_dt = interface.advance(dt)

                          
                          t = t + dt 
                        
                        interface.finalize()
                    </code></pre>
                </section>
                <!-- Write & read data: implement -->
                <section data-auto-animate>
                    <h2>Write & read data</h2>
                    <pre data-id="code-animation"><code class="language-python" data-trim data-line-numbers="25-31|44-46">
                        import numpy
                        import precice
                        
                        # generate mesh
                        n = 20
                        y = numpy.linspace(0, 1, n + 1)

                        # preCICE setup
                        participant_name     = "Generator"
                        config_file_name     = "precice-config.xml"
                        solver_process_index = 0
                        solver_process_size  = 1
                        interface = 
                            precice.Interface(  
                                               participant_name,
                                               config_file_name,
                                               solver_process_index,
                                               solver_process_size
                                             )
                        
                        # Get the preCICE mesh id
                        mesh_name  = "Generator-Mesh"
                        mesh_id    = interface.get_mesh_id(mesh_name)
                         
                        # Define the coupling mesh
                        vertices   = [[1, y0] for y0 in y[:-1]]
                        vertex_ids = interface.set_mesh_vertices(mesh_id, vertices)
                        
                        # Get the exchanged data id
                        data_name = "Data"
                        data_id = interface.get_data_id(data_name, mesh_id)
                        
                        precice_dt = interface.initialize()

                        dt = 0.01
                        t = 0

                        while interface.is_coupling_ongoing():
                          dt = np.minimum(dt, precice_dt)
                          
                          print("Generating data")
                          u = 1 - 2 * numpy.random.rand(n)
                          
                          interface.write_block_scalar_data(data_id, vertex_ids, u)
                          precice_dt = interface.advance(dt)
                          # interface.read_block_scalar_data(data_id, vertex_ids, u)
                          
                          t = t + dt 
                        
                        interface.finalize()
                    </code></pre>
                </section>
                </section>
                
                <!-- Run and results, part 2 -->
                <section>
                <section>It should work now!</small></section>
                <section>
                    <script id="asciicast-IwmCtbNoGxqgsrNEiA7mONPmv" src="https://asciinema.org/a/IwmCtbNoGxqgsrNEiA7mONPmv.js" async data-autoplay="true" data-size="medium" preload="1"></script>
                    <!-- <a href="https://asciinema.org/a/341510" target="_blank"><img src="https://asciinema.org/a/341510.svg" /></a> -->
                </section>
                <section>
                    <h2>Data is being transfered!</h2>
                    <p><a href="https://github.com/MakisH/ofw15-slides/blob/master/videos/propagator_coupled.webm"><video data-autoplay src="videos/propagator_coupled.webm"></video></a></p>
                    <small>Most basic case: uni-directional, serial-explicit, nearest-neighbor mapping, ...</small>
                </section>
                </section>
                
                <section>
                    <h2>Side note: Subcycling</h2>
                    <img src="images/level1/subcycling.svg" />
                </section>
                
                <!-- preCICE config -->
                <section>
                    <h2>preCICE configuration file</h2>
                    <section>
                    <small>Visual representation of precice-config.xml using the <a href="https://github.com/precice/config-visualizer" title="preCICE config visualizer">config visualizer</a>:</small>
                    <img src="images/level1/config-original.png" alt="Visual representation of the precice-config.xml"/>
                    </section>
                    <section>
                    <small><a href="https://github.com/MakisH/ofw15-slides/blob/master/generator-propagator/skeleton/precice-config.xml"><tt>precice-config.xml</tt></a>:</small>
                    <pre><code class="language-xml" data-trim data-line-numbers="2|4|6-12|14-17|19-26|19,22-24,26|28|30-36">
                        &lt;precice-configuration&gt;
                          &lt;solver-interface dimensions="2"&gt;

                          &lt;data:scalar name="Data"/&gt;

                          &lt;mesh name="Generator-Mesh"&gt;
                            &lt;use-data name="Data"/&gt;
                          &lt;/mesh&gt;

                          &lt;mesh name="Propagator-Mesh"&gt;
                            &lt;use-data name="Data" /&gt;
                          &lt;/mesh&gt;
                          
                          &lt;participant name="Generator"&gt;
                            &lt;use-mesh name="Generator-Mesh" provide="yes"/&gt;
                            &lt;write-data name="Data" mesh="Generator-Mesh"/&gt;
                          &lt;/participant&gt;

                          &lt;participant name="Propagator"&gt;
                            &lt;use-mesh name="Generator-Mesh" from="Generator"/&gt;
                            &lt;use-mesh name="Propagator-Mesh" provide="yes"/&gt;
                            &lt;mapping:nearest-neighbor direction="read"
                              from="Generator-Mesh" to="Propagator-Mesh"
                              constraint="consistent"/&gt;
                            &lt;read-data name="Data" mesh="Propagator-Mesh" /&gt;
                          &lt;/participant&gt;    

                          &lt;m2n:sockets from="Generator" to="Propagator"/&gt;

                          &lt;coupling-scheme:serial-explicit&gt;
                            &lt;participants first="Generator" second="Propagator"/&gt;
                            &lt;time-window-size value="0.01"/&gt;
                            &lt;max-time value="0.1"/&gt;
                            &lt;exchange data="Data" mesh="Generator-Mesh"
                              from="Generator" to="Propagator"/&gt;
                          &lt;/coupling-scheme:serial-explicit&gt;
                          
                          &lt;/solver-interface&gt;
                        &lt;/precice-configuration&gt;
                    </code></pre>
                </section>
                </section>
                
                <!-- Level 2: OpenFOAM + OpenFOAM -->
                <section data-markdown="sections/level2.md" data-separator-vertical="vvv"></section>
                
                <section>
                    <h2>Enabling the adapter</h2>
                    <div class="container">
                    <div class="col">
                    <pre><code class="language-cpp" data-trim data-line-numbers="">
                        // Fluid/system/controlDict
                        
                        functions
                        {
                        preCICE_Adapter
                        {
                            
                        type preciceAdapterFunctionObject;
                        libs ("libpreciceAdapterFunctionObject.so");
                        
                        }
                        }
                    </code></pre>
                    </div>
                    <div class="col">
                    <pre><code class="language-cpp" data-trim data-line-numbers="">
                        // Solid/system/controlDict
                        
                        functions
                        {
                        preCICE_Adapter
                        {
                            
                        type preciceAdapterFunctionObject;
                        libs ("libpreciceAdapterFunctionObject.so");
                        
                        }
                        }
                    </code></pre>
                    </div>
                    </div>
                    
                </section>
                
                <section>
                <h2>OpenFOAM adapter config</h2>
                <div class="container">
                <div class="col">
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Fluid/system/preciceDict
                    
                preciceConfig "precice-config.xml";

                participant Fluid;

                modules (CHT);

                interfaces
                {
                  Interface1
                  {
                    mesh      Fluid-Mesh;
                    patches   (interface);
                    
                    readData
                    (
                      Heat-Flux
                    );
                    
                    writeData
                    (
                      Temperature
                    );
                  };
                };
                </code></pre>
                </div>
                <div class="col">
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Solid/system/preciceDict
                    
                preciceConfig "precice-config.xml";

                participant Solid;

                modules (CHT);

                interfaces
                {
                  Interface1
                  {
                    mesh      Solid-Mesh;
                    patches   (interface);
                    
                    readData
                    (
                      Temperature
                    );
                    
                    writeData
                    (
                      Heat-Flux
                    );
                  };
                };

                CHT
                {
                   k   [ 1  1 -3 -1 0 0 0 ] 100;
                   solverType "basic";
                };
                </code></pre>
                </div>
                </div>
                </section>
                
                <section>
                <h2>The interface patch</h2>
                <div class="container">
                <div class="col">
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Fluid/system/blockMeshDict
                
                boundary
                (
                    interface
                    {
                        type wall;
                        faces
                        (
                            (4 0 1 5)
                        );
                    }

                    // ...
                );
                </code></pre>
                </div>
                <div class="col">
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Solid/system/blockMeshDict
                
                boundary
                (
                    interface
                    {
                        type wall;
                        faces
                        (
                            (7 6 2 3)
                        );
                    }
                    
                    // ...
                );
                </code></pre>
                </div>
                </div>
                </section>
                
                <section>
                <h2>OpenFOAM boundary conditions</h2>
                <div class="container">
                <div class="col">
                <pre><code class="language-cpp" data-trim data-line-numbers="1,7-11">
                // Fluid/0/T
                    
                internalField uniform 300;

                boundaryField
                {
                  interface
                  {
                    type      fixedGradient;
                    gradient  uniform 0;
                  }
                  inlet
                  {
                    type      fixedValue;
                    value     $internalField;
                  }
                  outlet
                  {
                    type      zeroGradient;
                  }
                  // ...
                }
                </code></pre>
                </div>
                <div class="col">
                <pre><code class="language-cpp" data-trim data-line-numbers="1,7-11">
                // Solid/0/T
                    
                internalField uniform 310;

                boundaryField
                {
                  interface
                  {
                    type      fixedValue;
                    value     $internalField;
                  }
                  left
                  {
                    type      zeroGradient;
                  }
                  // ...
                }
                </code></pre>
                </div>
                </div>
                </section>
                
                <section>
                <section>
                    <h2>precice-config.xml</h2>
                    <pre><code class="language-xml" data-trim data-line-numbers="3|5-6|8-16|18-26|18,26,21-22|18,26,23-25|18,26,23-25,19-20|28-36|40-58|40,58,41-42|40,58,43|40,58,44-47|48-50|51-57">
                        &lt;precice-configuration&gt;

                            &lt;solver-interface dimensions="3"&gt;

                            &lt;data:scalar name="Temperature"/&gt;
                            &lt;data:scalar name="Heat-Flux"/&gt;

                            &lt;mesh name="Fluid-Mesh"&gt;
                                &lt;use-data name="Temperature"/&gt;
                                &lt;use-data name="Heat-Flux"/&gt;
                            &lt;/mesh&gt;

                            &lt;mesh name="Solid-Mesh"&gt;
                                &lt;use-data name="Temperature"/&gt;
                                &lt;use-data name="Heat-Flux"/&gt;
                            &lt;/mesh&gt;

                            &lt;participant name="Fluid"&gt;
                                &lt;use-mesh name="Fluid-Mesh" provide="yes"/&gt;
                                &lt;use-mesh name="Solid-Mesh" from="Solid"/&gt;
                                &lt;read-data name="Heat-Flux" mesh="Fluid-Mesh"/&gt;
                                &lt;write-data name="Temperature" mesh="Fluid-Mesh"/&gt;
                                &lt;mapping:nearest-neighbor direction="read"
                                  from="Solid-Mesh" to="Fluid-Mesh"
                                  constraint="consistent"/&gt;
                            &lt;/participant&gt;

                            &lt;participant name="Solid"&gt;
                                &lt;use-mesh name="Fluid-Mesh" from="Fluid"/&gt;
                                &lt;use-mesh name="Solid-Mesh" provide="yes"/&gt;
                                &lt;read-data name="Temperature" mesh="Solid-Mesh"/&gt;
                                &lt;write-data name="Heat-Flux" mesh="Solid-Mesh"/&gt;
                                &lt;mapping:nearest-neighbor direction="read"
                                  from="Fluid-Mesh" to="Solid-Mesh"
                                  constraint="consistent"/&gt;
                            &lt;/participant&gt;

                            &lt;m2n:sockets from="Fluid" to="Solid"/&gt;

                            &lt;coupling-scheme:serial-implicit&gt;
                                &lt;time-window-size value="0.01"/&gt;
                                &lt;max-time value="1"/&gt;
                                &lt;participants first="Fluid" second="Solid"/&gt;
                                &lt;exchange data="Temperature" mesh="Fluid-Mesh"
                                  from="Fluid" to="Solid"/&gt;
                                &lt;exchange data="Heat-Flux" mesh="Solid-Mesh"
                                  from="Solid" to="Fluid"/&gt;
                                &lt;max-iterations value="200"/&gt;
                                &lt;relative-convergence-measure limit="1.0e-6"
                                  data="Temperature" mesh="Fluid-Mesh"/&gt;
                                &lt;acceleration:IQN-ILS&gt;
                                    &lt;data mesh="Solid-Mesh" name="Heat-Flux" /&gt;
                                    &lt;initial-relaxation value="0.01" /&gt;
                                    &lt;max-used-iterations value="80" /&gt;
                                    &lt;time-windows-reused value="10" /&gt;
                                    &lt;filter type="QR1" limit="1e-8" /&gt;
                                &lt;/acceleration:IQN-ILS&gt;
                            &lt;/coupling-scheme:serial-implicit&gt;

                            &lt;/solver-interface&gt;

                        &lt;/precice-configuration&gt;
                    </code></pre>
                </section>
                
                <section>
                    <h2>precice-config.xml</h2>
                    <img src="images/level2/precice-config.svg"/>
                    <small>Visual representation of precice-config.xml using the <a href="https://github.com/precice/config-visualizer" title="preCICE config visualizer">config visualizer</a></small>
                </section>
                </section>
                
                <section>
                    <script id="asciicast-341985" src="https://asciinema.org/a/341985.js" async data-autoplay="true" data-size="medium" preload="1"></script>
                    <!-- <a href="https://asciinema.org/a/341985" target="_blank"><img src="https://asciinema.org/a/341985.svg" /></a> -->
                </section>
                
                <section>
                    <p><a href="https://github.com/MakisH/ofw15-slides/blob/master/videos/heated_plate_paraview.webm"><video data-autoplay src="videos/heated_plate_paraview.webm"></video></a></p>
                    <small>"Flickering"? <a href="https://github.com/precice/openfoam-adapter/issues/26">Run <tt>./removeObsoleteFolders.sh</tt></a> first.</small>
                </section>
                
                <!-- Level 3: OpenFOAM + deal.II -->
                <section data-markdown="sections/level3.md" data-separator-vertical="vvv"></section>
                
                <section>
                <h2>Configure OpenFOAM</h2>
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Fluid/0.orig/U
                    
                flap
                {
                    type            movingWallVelocity;
                    value           uniform (0 0 0);
                }
                </code></pre>
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Fluid/0.orig/pointDisplacement
                    
                flap
                {
                    type            fixedValue;
                    value           $internalField;
                }
                </code></pre>
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Fluid/constant/dynamicMeshDict
                    
                solver      displacementLaplacian;
                </code></pre>
                </section>
                
                <section>
                <h2>Configure the OpenFOAM adapter</h2>
                <pre><code class="language-cpp" data-trim data-line-numbers="">
                // Fluid/system/preciceDict
                    
                preciceConfig "precice-config.xml";

                participant Fluid;

                modules (FSI);

                interfaces
                {
                  Interface1
                  {
                    mesh              Fluid-Mesh-Centers;
                    patches           (flap);
                    locations         faceCenters;
                    
                    readData
                    (
                    );
                    
                    writeData
                    (
                      Stress
                    );
                  };
                  
                  Interface2
                  {
                    mesh              Fluid-Mesh-Nodes;
                    patches           (flap);
                    locations         faceNodes;
                    
                    readData
                    (
                      Displacement
                    );
                    
                    writeData
                    (
                    );
                  };
                };

                FSI
                {
                  rho rho [1 -3 0 0 0 0 0] 1;
                }
                </code></pre>
                </section>
                
                <section>
                <h2>Configure the deal.ii adapter</h2>
                <div class="col">
                <pre><code class="language-text" data-trim data-line-numbers="">
                // Solid/linear_elasticity.prm
                    
                subsection precice configuration
                  # Cases: FSI3 or PF for perpendicular flap
                  set Scenario            = PF

                  # Name of the precice configuration file
                  set precice config-file = precice-config.xml

                  # Name of the participant in the precice-config.xml file
                  set Participant name    = Solid

                  # Name of the coupling mesh in the precice-config.xml file
                  set Mesh name           = Solid_mesh

                  # Name of the read data in the precice-config.xml file
                  set Read data name      = Stress

                  # Name of the write data in the precice-config.xml file
                  set Write data name     = Displacement
                end
                </code></pre>
                </div>
                </section>
                
                <section>
                <h2>Configure preCICE</h2>
                <div class="col">
                <pre><code class="language-xml" data-trim data-line-numbers="19-30|19,30,27-29|32,46,40-42|32,46,44-45|65-72">
                    &lt;precice-configuration&gt;
                        &lt;solver-interface dimensions="2"&gt;

                        &lt;data:vector name="Stress"/&gt;
                        &lt;data:vector name="Displacement"/&gt;

                        &lt;mesh name="Fluid-Mesh-Centers"&gt;
                            &lt;use-data name="Stress"/&gt;
                       &lt;/mesh&gt;
                        &lt;mesh name="Fluid-Mesh-Nodes"&gt;
                            &lt;use-data name="Displacement"/&gt;
                        &lt;/mesh&gt;

                        &lt;mesh name="Solid_mesh"&gt;
                            &lt;use-data name="Displacement"/&gt;
                            &lt;use-data name="Stress"/&gt;
                        &lt;/mesh&gt;

                        &lt;participant name="Fluid"&gt;
                            &lt;use-mesh name="Fluid-Mesh-Nodes" provide="yes"/&gt;
                            &lt;use-mesh name="Fluid-Mesh-Centers" provide="yes"/&gt;
                            &lt;use-mesh name="Solid_mesh" from="Solid"/&gt;
                            
                            &lt;read-data name="Displacement" mesh="Fluid-Mesh-Nodes"/&gt;
                            &lt;write-data name="Stress" mesh="Fluid-Mesh-Centers"/&gt;
                            
                            &lt;mapping:rbf-thin-plate-splines direction="read"
                                from="Solid_mesh" to="Fluid-Mesh-Nodes"
                                constraint="consistent"/&gt;
                        &lt;/participant&gt;

                        &lt;participant name="Solid"&gt;
                            &lt;use-mesh name="Solid_mesh" provide="yes"/&gt;
                            &lt;use-mesh name="Fluid-Mesh-Centers" from="Fluid"/&gt;
                            &lt;use-mesh name="Fluid-Mesh-Nodes" from="Fluid"/&gt;
                            
                            &lt;read-data name="Stress"  mesh="Solid_mesh"/&gt;
                            &lt;write-data name="Displacement" mesh="Solid_mesh"/&gt;
                            
                            &lt;mapping:rbf-thin-plate-splines direction="read"
                                from="Fluid-Mesh-Centers" to="Solid_mesh"
                                constraint="consistent" /&gt;
                                
                            &lt;watch-point mesh="Solid_mesh" name="flap_tip"
                                coordinate="-0.05;1;0" /&gt;
                        &lt;/participant&gt;

                        &lt;m2n:sockets from="Fluid" to="Solid" /&gt;

                        &lt;coupling-scheme:serial-implicit&gt;
                            &lt;time-window-size value="0.01"/&gt;
                            &lt;max-time value="5"/&gt;
                            &lt;participants first="Fluid" second="Solid"/&gt;
                            &lt;exchange data="Stress" mesh="Fluid-Mesh-Centers"
                                from="Fluid" to="Solid"/&gt;
                            &lt;exchange data="Displacement" mesh="Solid_mesh"
                                from="Solid" to="Fluid" initialize="0"/&gt;

                            &lt;max-iterations value="50"/&gt;
                            &lt;relative-convergence-measure limit="1e-4"
                                data="Stress" mesh="Fluid-Mesh-Centers"/&gt;
                            &lt;relative-convergence-measure limit="1e-4"
                                data="Displacement" mesh="Solid_mesh"/&gt;

                            &lt;acceleration:IQN-ILS&gt;
                                &lt;data name="Displacement" mesh="Solid_mesh"/&gt;
                                &lt;preconditioner type="residual-sum"/&gt;
                                &lt;filter type="QR1" limit="1e-6"/&gt;
                                &lt;initial-relaxation value="0.1"/&gt;
                                &lt;max-used-iterations value="50"/&gt;
                                &lt;time-windows-reused value="10"/&gt;
                            &lt;/acceleration:IQN-ILS&gt;

                        &lt;/coupling-scheme:serial-implicit&gt;
                        &lt;/solver-interface&gt;
                    &lt;/precice-configuration&gt;
                </code></pre>
                </div>
                </section>
                
                <section>
                <section>
                    <script id="asciicast-342273" src="https://asciinema.org/a/342273.js" async data-autoplay="true" data-size="medium" preload="1"></script>
                    <!-- <a href="https://asciinema.org/a/341806" target="_blank"><img src="https://asciinema.org/a/341806.svg" /></a> -->
                </section>
                
                <section>
                    <p><a href="https://github.com/MakisH/ofw15-slides/blob/master/videos/openfoam_dealii_paraview.webm"><video data-autoplay src="videos/openfoam_dealii_paraview.webm" style="width:600px;"></video></a></p>
                    <small>Linear solid model</small>
                </section>
           
                <section>
                    <h2>How is the tip moving?</h2>
                    <div class="container">
                        <div class="col">
                            <pre><code class="language-bash" data-trim data-line-numbers="">
                                #! /bin/bash
                                gnuplot -p << EOF
                                set grid
                                set title 'Displacement of the Flap Tip'
                                set xlabel 'Time [s]'
                                set ylabel 'X-Displacement [m]'
                                set linestyle  1 lt 2 lc 1 # red-dashed
                                plot "precice-Solid-watchpoint-flap_tip.log"
                                    using 1:4 
                                    title 'Top displacemement'
                                    with lines
                                EOF
                            </code></pre>
                        </div>
                        <div class="col">
                            <img src="images/level3/watchpoint.svg"/>
                        </div>
                    </div>
                </section>
                </section>
                
                <!-- CalculiX -->
                <section>
                    <h2>See also: OpenFOAM + CalculiX</h2>
                    
                    <a href="https://asciinema.org/a/341806" target="_blank"><img src="https://asciinema.org/a/341806.svg" style="width:600px"/></a>
                </section>
                
                <!-- Resources -->
                <section data-markdown="sections/resources.md" data-separator-vertical="vvv"></section>
                
                <!-- Closing -->
                <section data-markdown="sections/closing.md" data-separator-vertical="vvv"></section>
            </div>
        </div>

        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script>
            // More info about initialization & config:
            // - https://revealjs.com/initialization/
            // - https://revealjs.com/config/
            Reveal.initialize({
                width: 960,
                height: 700,
                center: true,
                controls: true,
                controlsTutorial: false,
                progress: true,
                slideNumber: false,
                center: true,
                hash: true,
                transition: 'none', // none/fade/slide/convex/concave/zoom
                backgroundTransition: 'none', // none/fade/slide/convex/concave/zoom
                defaultTiming: 50,
                // Learn about plugins: https://revealjs.com/plugins/
                plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
            });
        </script>
    </body>
</html>
